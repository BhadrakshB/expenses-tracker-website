---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import MobileStickyCTA from "../components/MobileStickyCTA.astro";

// Full Page Variants - Two completely different website designs
import SiteVariantA from "../components/SiteVariantA.astro";
import SiteVariantB from "../components/SiteVariantB.astro";

// Server-side Logic
let preLaunch = true;
let variant = "A";

try {
  const { app } = await import("../firebase/server");
  const { getFirestore } = await import("firebase-admin/firestore");

  const db = getFirestore(app);
  const configRef = db.collection("config").doc("website-config");
  const doc = await configRef.get();

  if (doc.exists) {
    const data = doc.data();
    preLaunch = data?.preLaunch ?? true;
  }
} catch (error) {
  console.error("Error fetching config server-side:", error);
}

// Simple Server-Side A/B Testing
// Check for existing cookie
const cookieVariant = Astro.cookies.get("hero_variant")?.value;

if (cookieVariant && (cookieVariant === "A" || cookieVariant === "B")) {
  variant = cookieVariant;
} else {
  // Random assignment (50/50)
  variant = Math.random() > 0.5 ? "B" : "A";
  Astro.cookies.set("hero_variant", variant, {
    path: "/",
    maxAge: 60 * 60 * 24 * 30,
  }); // 30 days
}

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "MobileApplication",
  name: "Expenses Tracker",
  operatingSystem: "iOS, Android",
  applicationCategory: "FinanceApplication",
  offers: {
    "@type": "Offer",
    price: "0",
    priceCurrency: "USD",
  },
  aggregateRating: {
    "@type": "AggregateRating",
    ratingValue: "0",
    ratingCount: "0",
  },
};
---

<BaseLayout
  title="Track Every Cent"
  description="Take control of your money with Expenses Tracker. Offline-first expense tracking, AI insights, bank SMS detection, and beautiful reports. Free download."
>
  <Fragment slot="structured-data">
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  </Fragment>

  <Header slot="header" />

  <!-- Full Page Variants - Server-side rendered, no loading delay -->
  {variant === "A" && <SiteVariantA preLaunch={preLaunch} />}
  {variant === "B" && <SiteVariantB preLaunch={preLaunch} />}

  <Footer slot="footer" />
  <MobileStickyCTA slot="mobile-cta" />
</BaseLayout>

<!-- Track variant for PostHog analytics -->
<script define:vars={{ variant, preLaunch }}>
  // Track which variant was shown for A/B test analytics
  if (typeof window !== "undefined" && window.posthog) {
    window.posthog.capture("site_variant_viewed", {
      site_variant: variant,
      pre_launch: preLaunch,
    });
  }
</script>
